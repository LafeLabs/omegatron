<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">

        <!--


    -->
    
<link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//wAA4A8AAO/vAADqrwAA6q8AAOqvAADqrwAA6q8AAOqvAADqrwAA7+8AAMAHAADf9wAAwAcAAPu/AAD4PwAA" rel="icon" type="image/x-icon" />


       <!--Stop Google:-->
    <META NAME="robots" CONTENT="noindex,nofollow">
   <title>THERMOTRON</title>    
   <script src = "https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/p5@1.7.0/lib/p5.js"></script>

</head>
<body>


   <input id = "datainput"/>


<textarea id = "jsonio"></textarea>
<script>
document.getElementById("datainput").value = "";
document.getElementById("datainput").select();

squareWidth = 600;

timeindex = 0;

function setup() {
    createCanvas(squareWidth,squareWidth);
//    background(159,135,103);
    background(255);
    stroke(0);
    strokeWeight(10);
//      image(img, 0, 0,squareWidth-50,squareWidth-70);
}


function draw() {
  
  stroke(0);

    
}


metadata = "omegatron IV curve tracer";
        //add a input for the metadata

Iwave = [];
Vwave = [];

document.getElementById("datainput").onchange = function(){
    rawtext =  this.value;
    this.value = "";
    I = parseFloat(rawtext.split(" volts")[1].split(" miroamperes")[0]);
    V = parseFloat(rawtext.split(" volts")[0])
    Vwave.push(V);
    Iwave.push(I);

    clear();
    background(255);
    strokeWeight(1);
    stroke(0);
    textSize(10);
    strokeWeight(4);
    fill(0);
    circle(width/2  + map(V, -1.5, 1.5, -width/2, width/2),height/2 + map(I, -150, 150, -height/2, height/2),20);
    

    beginShape();
    noFill();
    for(var i = 0; i < Iwave.length; i++){
        vertex(width/2  + map(Vwave[i], -1.5, 1.5, -width/2, width/2),height/2 + map(Iwave[i], -150, 150, -height/2, height/2));
    }
    endShape();



    timeindex++;
    if(timeindex > 1000){
        timeindex = 0;
        data = {};
        data.metadata = metadata;
        data.I = Iwave;
        data.V = Vwave;

        document.getElementById("jsonio").value = JSON.stringify(data,null,"    ");
        //save JSON data file in thermotron_data/
        //save png file in thermotron_plots/
        //load all the plots in a plot feed, click on them to get data, all saved by unix time, which marks end of timewave
        png64 = document.getElementById("defaultCanvas0").toDataURL("image/png");
        var timestamp = Math.round((new Date().getTime())/1000).toString();

        var httpc = new XMLHttpRequest();
        var url = "pngsave.php";        
        httpc.open("POST", url, true);
        httpc.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        httpc.send("data="+encodeURIComponent(png64.substring(22))+"&filename=omegatron_plots/omegatron_plot_" + timestamp +  ".png");//send text to filesaver.php
         //location.reload(); 

        var url = "filesaver.php";        
        var httpc2 = new XMLHttpRequest();
        httpc2.open("POST", url, true);
        httpc2.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        httpc2.send("data="+encodeURIComponent(JSON.stringify(data,null,"    "))+"&filename=omegatron_data/omegatron_data_" + timestamp +".txt");//send text to filesaver.php
         
        Iwave = [];
        Vwave = [];
    }
}

</script>
<style>
body, table{
    font-family:Comic Sans MS;
}
input{
    width:40em;
    font-size:1em;
    font-family:courier;
    background-color:black;
    color:#00ff00;
}
textarea{
    font-family:courier;
    background-color:black;
    color:#00ff00;
}
main{
    position:absolute;
    right:5px;
    bottom:5px;
}
main canvas{
    border:solid;
}
#datainput{
    position:absolute;
    right:5px;
    top:5px;
}
table{
    font-size:3em;
}
#row1{
    color:red;
}
#row2{
    color:green;
}
#row3{
    color:blue;
}
#row4{
    color:purple;
}

</style>
</body>
</html>


